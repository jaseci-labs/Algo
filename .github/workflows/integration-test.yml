# Integration Tests for Algo
# Runs full-stack tests on every PR to main, push to main, and every 6 hours
# This prevents breaking changes from being merged and catches upstream Jaseci issues

name: Integration Tests

on:
  schedule:
    - cron: '0 0,6,12,18 * * *'  # Runs at 00:00, 06:00, 12:00, 18:00 UTC daily
  pull_request:
    branches:
      - main
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      jaseci_ref:
        description: 'Jaseci branch/tag/SHA to test against'
        required: false
        default: 'main'

permissions:
  contents: read

jobs:
  integration-test:
    name: Full-stack Integration Tests
    runs-on: ubuntu-latest

    steps:
      # Checkout the repository
      - name: Checkout code
        uses: actions/checkout@v4

      # Set up Python
      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      # Cache pip dependencies for faster builds
      - name: Cache pip packages
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('tests/integration/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      # Install Bun for client bundling
      - name: Install Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      # Clone jaseci repo for source installation
      - name: Clone jaseci repo
        run: |
          REF="${{ github.event.inputs.jaseci_ref || 'main' }}"
          git clone --depth 1 --recurse-submodules --branch "$REF" \
            https://github.com/jaseci-labs/jaseci.git /tmp/jaseci
          echo "JASECI_SHA=$(git -C /tmp/jaseci rev-parse --short HEAD)" >> $GITHUB_ENV
          echo "Cloned jaseci at $(git -C /tmp/jaseci rev-parse HEAD)"

      # Install Jaseci packages from source
      - name: Install jaseci packages from source
        run: |
          pip install --upgrade pip
          pip install -e /tmp/jaseci/jac
          pip install -e /tmp/jaseci/jac-byllm
          pip install -e /tmp/jaseci/jac-client

      # Install Python test dependencies
      - name: Install test dependencies
        run: |
          pip install requests pytest

      # Verify installation
      - name: Verify installation
        run: |
          echo "=== Jac Version ==="
          jac --version
          echo "=== Plugins ==="
          jac plugins list
          echo "=== Jaseci SHA ==="
          echo "${{ env.JASECI_SHA }}"

      # Start Jac server in background
      - name: Start Jac server
        run: |
          echo "Starting Jac server..."
          jac start main.jac > /tmp/jac_server.log 2>&1 &
          JAC_PID=$!
          echo "Jac server PID: $JAC_PID"
          echo $JAC_PID > /tmp/jac_pid.txt

      # Wait for server to be ready
      - name: Wait for server
        run: |
          echo "Waiting for server to start..."
          for i in {1..60}; do
            if curl -s http://localhost:8000/app/health > /dev/null 2>&1; then
              echo "Server is ready!"
              break
            fi
            if [ $i -eq 60 ]; then
              echo "Server did not start within 60 seconds"
              echo "=== Server Log ==="
              cat /tmp/jac_server.log
              exit 1
            fi
            sleep 1
          done

      # Show server status
      - name: Show server status
        run: |
          echo "=== Jac Server Status ==="
          cat /tmp/jac_server.log || true
          curl -s http://localhost:8000/ || true

      # Run integration tests
      - name: Run integration tests
        run: |
          python tests/integration/run_tests.py
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          TEST_MODE: ci

      # Capture server logs on failure
      - name: Capture server logs on failure
        if: failure()
        run: |
          echo "=== Server Logs ==="
          cat /tmp/jac_server.log || true
          echo "=== Process Status ==="
          ps aux | grep jac || true

      # Shutdown server
      - name: Shutdown server
        if: always()
        run: |
          if [ -f /tmp/jac_pid.txt ]; then
            JAC_PID=$(cat /tmp/jac_pid.txt)
            kill $JAC_PID 2>/dev/null || true
            echo "Killed Jac server (PID: $JAC_PID)"
          fi
          pkill -f "jac start" 2>/dev/null || true

      # Job summary
      - name: Job summary
        if: always()
        run: |
          echo "## Algo Integration Test" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Detail | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Jaseci SHA** | \`${{ env.JASECI_SHA }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Jaseci ref** | \`${{ github.event.inputs.jaseci_ref || 'main' }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Status** | \`${{ job.status }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Trigger** | \`${{ github.event_name }}\` |" >> $GITHUB_STEP_SUMMARY
